<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.phgym.mypage.model.MypageMapper">
	<insert id="doCheckin" parameterType="int">
		insert into checkin_his values (#{sessionUserNo}, sysdate)
	</insert>
	
	<select id="checkCheckin" parameterType="int" resultType="int">
		select count(*) from checkin_his where user_no = #{sessionUserNo} and trunc(checkin_date) = trunc(sysdate)
	</select>
	
	<insert id="doTransfer" parameterType="com.phgym.mypage.model.MembershipPayHisDTO">
		insert into membership_pay_his(membership_pay_no, user_no, end_date, remark_transfer_status, remark_transfer_date, remark_pay_no)
		values(membership_pay_his_seq.nextval, #{userNo}, #{endDate}, 'R', sysdate, #{membershipPayNo})
	</insert>
	
	<update id="updateRemarkTransferState" parameterType="com.phgym.mypage.model.MembershipPayHisDTO">
		update membership_pay_his set remark_transfer_status = 'G' where membership_pay_no = #{membershipPayNo} and user_no = #{userNo}
	</update>
	
	<select id="selectEndDate">
		select end_date from membership_pay_his where membership_pay_no = #{membershipPayNo}
	</select>
	
	<select id="checkTransfer" parameterType="int" resultType="com.phgym.mypage.model.MembershipPayHisDTO">
		select * from membership_pay_his where user_no = #{sessionUserNo} and remark_transfer_status is null order by membership_pay_no
	</select>
	
	<select id="getCheckinList" parameterType="int" resultType="com.phgym.mypage.model.CheckinHisDTO">
		select * from checkin_his where user_no = #{sessionUserNo} order by checkin_date desc
	</select>
	
	<select id="getMembershipPeriod" parameterType="com.phgym.mypage.model.CheckinHisDTO" resultType="com.phgym.mypage.model.CheckinListDTO">
		select to_char(a.checkin_date, 'yyyy-mm-dd') as checkin_date, to_char(a.checkin_date, 'hh24:mi:ss') as checkin_time, to_char(b.start_date, 'yyyy-mm-dd') as start_date, to_char(b.end_date, 'yyyy-mm-dd') as end_date
		from checkin_his a
		left join membership_pay_his b
		on a.user_no = b.user_no
		where a.user_no = #{userNo} and a.checkin_date between b.start_date and b.end_date order by checkin_date desc
	</select>
	
	<select id="getTimeList" parameterType="com.phgym.mypage.model.PtReservationHisDTO" resultType="com.phgym.mypage.model.PtReservationHisDTO">
		select * 
		from pt_reservation_his
		where admin_no = #{adminNo}
		and to_char(reservation_date, 'yyyy-MM-dd' ) = to_char(#{reservationDate}, 'yyyy-MM-dd' ) 
	</select>
	
	<insert id="doPtReservation" parameterType="com.phgym.mypage.model.PtReservationHisDTO">
		insert into pt_reservation_his(pt_reservation_his_no, user_no, admin_no, reservation_date) values (pt_reservation_his_seq.nextval, #{userNo}, #{adminNo}, #{reservationDate})
	</insert>
	
	<select id="checkUserInfo" parameterType="int" resultType="com.phgym.mypage.model.MypageUserInfoDTO">
		select * from user_info where user_no = #{userNo}
	</select>
	
	<select id="getTotalPtCnt" parameterType="int" resultType="int">
		select nvl(sum(pay_cnt), 0) from pt_pay_his where user_no = ${sessionUserNo}
	</select>
	
	<select id="getDidPtCnt" parameterType="int" resultType="int">
		select count(*) from pt_reservation_his where user_no = #{sessionUserNo} and (progress_status = 'Y' or progress_status is null)
	</select>
</mapper>